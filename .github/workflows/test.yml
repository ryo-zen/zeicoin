name: Test

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          cmake \
          git \
          curl \
          wget \
          unzip \
          pkg-config \
          librocksdb-dev \
          libc6-dev \
          ca-certificates

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        version: 0.14.1

    - name: Prepare Zig environment
      run: |
        # Clear any existing cache to avoid corruption
        echo "Clearing existing cache..."
        rm -rf ~/.cache/zig
        rm -rf .zig-cache
        rm -rf zig-cache

        # Create fresh cache directories
        echo "Creating cache directories..."
        mkdir -p ~/.cache/zig
        mkdir -p .zig-cache
        mkdir -p zig-cache
        chmod -R 755 ~/.cache/zig

        # Show Zig version and environment
        echo "Zig version:"
        zig version
        echo "Zig environment:"
        zig env

        # Fetch dependencies fresh with verbose output
        echo "Fetching Zig dependencies..."
        zig build --fetch --verbose 2>&1 || echo "Fetch failed with exit code $?, continuing anyway..."

        # Show what was created
        echo "Cache directory structure:"
        ls -la ~/.cache/zig/ || echo "No cache directory"

        # Try to create the missing directory manually
        echo "Creating potentially missing directories..."
        mkdir -p ~/.cache/zig/b
        mkdir -p ~/.cache/zig/p

    - name: Build RandomX
      run: |
        echo "Building RandomX..."
        mkdir -p randomx/randomx_build
        cd randomx/randomx_build
        if [ ! -d "RandomX" ]; then
          git clone https://github.com/tevador/RandomX.git
          cd RandomX
          git checkout v1.2.1
          cd ..
        fi
        cd RandomX
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="../../randomx_install"
        make -j$(nproc)
        make install
        cd ../../../..
        gcc -o randomx/randomx_helper randomx/randomx_helper.c randomx/wrapper.c \
          -Irandomx/randomx_build/randomx_install/include \
          -Lrandomx/randomx_build/randomx_install/lib -lrandomx -lstdc++ -lm

    - name: Build project
      run: |
        echo "Starting build..."
        echo "Cache contents before build:"
        ls -la ~/.cache/zig/ 2>/dev/null || echo "No cache dir"
        echo "---"

        # Run build with verbose output to see what's happening
        zig build --verbose 2>&1 || {
          EXIT_CODE=$?
          echo "Build failed with exit code: $EXIT_CODE"
          echo "Cache contents after failed build:"
          ls -la ~/.cache/zig/ 2>/dev/null || echo "No cache dir"
          echo "Checking if specific directory exists:"
          ls -la ~/.cache/zig/b/ 2>/dev/null || echo "No b directory"
          exit $EXIT_CODE
        }

    - name: Run tests
      run: zig build test